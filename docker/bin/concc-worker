#!/bin/sh

MOUNT_SH=/tmp/mount.sh
PASSWORD=/tmp/password

MAX_JOBS=${CONCC_MAX_JOBS:-$(nproc)}
echo $MAX_JOBS >/tmp/.concc-max-jobs

sed -i "s|#MaxSessions .*|MaxSessions $MAX_JOBS|" /etc/ssh/sshd_config
/etc/init.d/ssh start

while true
do
  if [ -f $MOUNT_SH ] && [ -f $PASSWORD ]
  then
    break
  else
    sleep 1
  fi
done

touch /tmp/ready

echo "Mounting the workspace directory..."
sh $MOUNT_SH
