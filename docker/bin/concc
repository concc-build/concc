#!/bin/sh

export CONCC_DIR=/home/concc

PROGNAME=$(basename $0)
BASEDIR=$(cd $(dirname $0); pwd)

DEFAULT_SSH_PORT=22
NOENT_EXCLUDE=/workspace/.noent-exclude

WORKDIR=$(pwd)
PROJECT=$(hostname)
WORKERS=
VERBOSE=0

help() {
  cat <<EOF >&2
Execute a script with concc distributed build system

USAGE:
  $PROGNAME [-l] [-c <client>] [-w <workers>] [-v <verbose>] <script>
  $PROGNAME -h | --help

OPTIONS:
  -C <dir>
    Change to <dir> before doing anything else.

  -l, --local
    Run jobs locally.

  -p, --project <client> [default: '$PROJECT']
    A colon-separated pair of the hostname and the port number of the project
    container in the form <hostname>[:<port>].

  -w, --workers <workers> [default: '$WORKERS']
    A comma-separated list of worker containers to be connected.

  -v, --verbose <verbose> [default: $VERBOSE]
    Verbose level.

ARGUMENTS:
  <script>
    A script to be executed by the concc user on the client container.
EOF
  exit 0
}

log() {
  echo "$1" >&2
}

vlog() {
  if [ $VERBOSE -ge $1 ]
  then
    log "$2"
  fi
}

error() {
  log "ERROR: $1"
  exit 1
}

while [ $# -gt 0 ]
do
  case "$1" in
    '-h' | '--help')
      help
      ;;
    '-C')
      WORKDIR="$(cd $2; pwd)"
      shift 2
      ;;
    '-l' | '--local')
      export CONCC_RUN_LOCALLY=1
      shift
      ;;
    '-p' | '--project')
      PROJECT="$2"
      shift 2
      ;;
    '-w' | '--workers')
      WORKERS="$2"
      shift 2
      ;;
    '-v' | '--verbose')
      VERBOSE=$2
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

SCRIPT="$@"

PROJECT_HOST=$(echo "$PROJECT:" | cut -d ':' -f 1)
PROJECT_PORT=$(echo "$PROJECT:" | cut -d ':' -f 2)
PROJECT_PORT=${PROJECT_PORT:-$DEFAULT_SSH_PORT}
PROJECT="$PROJECT_HOST:$PROJECT_PORT"

CONCC_UID=$(ls -ld /workspace | cut -d ' ' -f 3)
if getent passwd $CONCC_UID
then
   CONCC_UID=$(getent passwd $CONCC_UID | cut -d ':' -f 3)
fi

CONCC_GID=$(ls -ld /workspace | cut -d ' ' -f 4)
if getent group $CONCC_GID
then
  CONCC_GID=$(getent group $CONCC_GID | cut -d ':' -f 3)
fi

vlog 1 "Creating a user account for concc with $CONCC_UID:$CONCC_GID..."
groupadd -o -g $CONCC_GID concc
useradd -o -m -g $CONCC_GID -u $CONCC_UID concc

vlog 1 "Copying /home/concc/.ssh from /root/.ssh..."
cp -R /root/.ssh /home/concc/
chown -R concc:concc /home/concc/.ssh

if [ -x /opt/concc/scripts/setup-client ]
then
  vlog 1 "Run setup-client..."
  /opt/concc/scripts/setup-client $PROJECT
fi

vlog 1 "Initializing the worker pool..."
gosu concc concc-worker-pool reset

if [ "$CONCC_DEBUG_SSHFS" = 1 ]
then
  SSHFS_RUN_MODE='-d'
else
  SSHFS_RUN_MODE='-f'
fi
SSHFS_OPTIONS="-o ssh_command='sshpass -f /tmp/password ssh'"
SSHFS_OPTIONS="$SSHFS_OPTIONS -o idmap=user"
SSHFS_OPTIONS="$SSHFS_OPTIONS -o cache=yes"
SSHFS_OPTIONS="$SSHFS_OPTIONS -o kernel_cache"
if [ -f $NOENT_EXCLUDE ]
then
  SSHFS_OPTIONS="$SSHFS_OPTIONS -o noent_exclude='$(cat $NOENT_EXCLUDE)'"
fi
cat <<EOF >/tmp/mount.sh
/opt/concc/bin/sshfs $SSHFS_RUN_MODE -p $PROJECT_PORT $SSHFS_OPTIONS \
  concc@$PROJECT_HOST:/workspace /workspace
EOF

for WORKER in $(echo "$WORKERS" | tr ',' ' ')
do
  WORKER_HOST=$(echo "$WORKER:" | cut -d ':' -f 1)
  WORKER_PORT=$(echo "$WORKER:" | cut -d ':' -f 2)
  WORKER_PORT=${WORKER_PORT:-$DEFAULT_SSH_PORT}
  WORKER="$WORKER_HOST:$WORKER_PORT"

  if ssh -p $WORKER_PORT $WORKER_HOST test -f /tmp/ready
  then
    vlog 1 "$WORKER: Already started"
    continue
  fi

  if [ -x /opt/concc/scripts/setup-worker ]
  then
    vlog 1 "Running setup-worker..."
    /opt/concc/scripts/setup-worker $PROJECT $WORKER
  fi

  LIMIT=$(ssh -p $WORKER_PORT $WORKER_HOST cat /tmp/.concc-max-jobs)
  vlog 1 "$WORKER: Maximum number of jobs: $LIMIT"

  vlog 1 "Add $WORKER to the worker pool..."
  gosu concc concc-worker-pool add $WORKER $LIMIT

  vlog 1 "$WORKER: Mounting the workspace directory from $PROJECT..."
  scp -P $WORKER_PORT /tmp/mount.sh $WORKER_HOST:/tmp/mount.sh
  scp -P $WORKER_PORT /run/secrets/password $WORKER_HOST:/tmp/.password
  ssh -p $WORKER_PORT $WORKER_HOST mv /tmp/.password /tmp/password
  while ! ssh -p $WORKER_PORT $WORKER_HOST test -f /tmp/ready
  do
    sleep 1
  done
done

vlog 1 "Total maximum number of jobs: $(gosu concc concc-worker-pool limit)"

(cd $WORKDIR; exec gosu concc sh -c "$SCRIPT")
