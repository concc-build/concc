#!/bin/sh

if [ "$CONCC_DEBUG_DISPATCH" = 1 ]
then
  set -ex
fi

if [ -x /opt/concc/scripts/run-locally ]
then
  if /opt/concc/scripts/run-locally "$@"
  then
    exec "$@"  # run locally
  fi
fi

SLEEP=${CONCC_DEFAULT_SLEEP:-5}
WORKER=

release() {
  if [ -n "$WORKER" ]
  then
    concc-worker-pool release $WORKER
  fi
}

trap release EXIT INT TERM

while true
do
  WORKER=$(concc-worker-pool allocate)
  if [ -n "$WORKER" ]
  then
    break
  fi
  sleep $SLEEP
done

WORKER_HOST=$(echo $WORKER | cut -d ':' -f 1)
WORKER_PORT=$(echo $WORKER | cut -d ':' -f 2)
# TODO: Using the workspace directory shared via SSHFS may be faster than the code below.
SCRIPT_FILE=$(ssh -p $WORKER_PORT root@$WORKER_HOST mktemp)
concc-scriptify "$@" | ssh -p $WORKER_PORT root@$WORKER_HOST "cat >$SCRIPT_FILE"
ssh -p $WORKER_PORT root@$WORKER_HOST sh $SCRIPT_FILE
